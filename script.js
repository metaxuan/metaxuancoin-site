const translations = {
  "en": {
    "start": "Start Transfer",
    "title": "MetaXuan Coin",
    "address": "Recipient Address",
    "amount": "Amount",
    "enterAddress": "Enter recipient address",
    "enterAmount": "Enter amount",
    "send": "Send",
    "back": "Back",
    "balance": "Wallet Balance",
    "connect": "Connect Wallet",
    "connected": "Wallet Connected",
    "network": "Network",
    "ethBalance": "ETH Balance",
    "tokenBalance": "MXN Balance"
  },
  "zh-TW": {
    "start": "開始轉帳",
    "title": "玄元幣",
    "address": "接收地址",
    "amount": "轉帳金額",
    "enterAddress": "請輸入接收地址",
    "enterAmount": "請輸入金額",
    "send": "轉帳",
    "back": "返回",
    "balance": "錢包餘額",
    "connect": "連接錢包",
    "connected": "錢包已連接",
    "network": "網路",
    "ethBalance": "ETH 餘額",
    "tokenBalance": "MXN 餘額"
  },
  "zh-CN": {
    "start": "开始转账",
    "title": "玄元币",
    "address": "接收地址",
    "amount": "转账金额",
    "enterAddress": "请输入接收地址",
    "enterAmount": "请输入金额",
    "send": "转账",
    "back": "返回",
    "balance": "钱包余额",
    "connect": "连接钱包",
    "connected": "钱包已连接",
    "network": "网络",
    "ethBalance": "ETH 余额",
    "tokenBalance": "MXN 余额"
  },
  "ja": {
    "start": "送金開始",
    "title": "メタシュアンコイン",
    "address": "受取アドレス",
    "amount": "送金額",
    "enterAddress": "アドレスを入力",
    "enterAmount": "金額を入力",
    "send": "送金",
    "back": "戻る",
    "balance": "ウォレット残高",
    "connect": "ウォレット接続",
    "connected": "接続済み",
    "network": "ネットワーク",
    "ethBalance": "ETH 残高",
    "tokenBalance": "MXN 残高"
  },
  "ko": {
    "start": "송금 시작",
    "title": "메타쉬안코인",
    "address": "수신 주소",
    "amount": "송금 금액",
    "enterAddress": "수신 주소 입력",
    "enterAmount": "금액 입력",
    "send": "송금",
    "back": "뒤로가기",
    "balance": "지갑 잔액",
    "connect": "지갑 연결",
    "connected": "지갑 연결됨",
    "network": "네트워크",
    "ethBalance": "ETH 잔액",
    "tokenBalance": "MXN 잔액"
  },
  "es": {
    "start": "Iniciar transferencia",
    "title": "Moneda MetaXuan",
    "address": "Dirección del destinatario",
    "amount": "Monto",
    "enterAddress": "Ingrese la dirección",
    "enterAmount": "Ingrese el monto",
    "send": "Enviar",
    "back": "Atrás",
    "balance": "Saldo de billetera",
    "connect": "Conectar billetera",
    "connected": "Billetera conectada",
    "network": "Red",
    "ethBalance": "Saldo ETH",
    "tokenBalance": "Saldo MXN"
  },
  "th": {
    "start": "เริ่มโอน",
    "title": "เหรียญเมตาซวน",
    "address": "ที่อยู่ผู้รับ",
    "amount": "จำนวนเงิน",
    "enterAddress": "กรอกที่อยู่",
    "enterAmount": "กรอกจำนวน",
    "send": "โอน",
    "back": "ย้อนกลับ",
    "balance": "ยอดคงเหลือกระเป๋า",
    "connect": "เชื่อมต่อกระเป๋า",
    "connected": "เชื่อมต่อแล้ว",
    "network": "เครือข่าย",
    "ethBalance": "ยอด ETH",
    "tokenBalance": "ยอด MXN"
  },
  "vi": {
    "start": "Bắt đầu chuyển khoản",
    "title": "MetaXuan Coin",
    "address": "Địa chỉ người nhận",
    "amount": "Số tiền",
    "enterAddress": "Nhập địa chỉ người nhận",
    "enterAmount": "Nhập số tiền",
    "send": "Gửi",
    "back": "Quay lại",
    "balance": "Số dư ví",
    "connect": "Kết nối ví",
    "connected": "Ví đã kết nối",
    "network": "Mạng",
    "ethBalance": "Số dư ETH",
    "tokenBalance": "Số dư MXN"
  },
  "fr": {
    "start": "Commencer le transfert",
    "title": "Pièce MetaXuan",
    "address": "Adresse du destinataire",
    "amount": "Montant",
    "enterAddress": "Entrez l'adresse du destinataire",
    "enterAmount": "Entrez le montant",
    "send": "Envoyer",
    "back": "Retour",
    "balance": "Solde du portefeuille",
    "connect": "Connecter le portefeuille",
    "connected": "Portefeuille connecté",
    "network": "Réseau",
    "ethBalance": "Solde ETH",
    "tokenBalance": "Solde MXN"
  },
  "de": {
    "start": "Überweisung starten",
    "title": "MetaXuan Münze",
    "address": "Empfängeradresse",
    "amount": "Betrag",
    "enterAddress": "Empfängeradresse eingeben",
    "enterAmount": "Betrag eingeben",
    "send": "Senden",
    "back": "Zurück",
    "balance": "Wallet-Guthaben",
    "connect": "Wallet verbinden",
    "connected": "Wallet verbunden",
    "network": "Netzwerk",
    "ethBalance": "ETH-Guthaben",
    "tokenBalance": "MXN-Guthaben"
  },
  "hi": {
    "start": "स्थानांतरण प्रारंभ करें",
    "title": "मेटा ज़ुआन सिक्का",
    "address": "प्राप्तकर्ता पता",
    "amount": "राशि",
    "enterAddress": "प्राप्तकर्ता का पता दर्ज करें",
    "enterAmount": "राशि दर्ज करें",
    "send": "भेजें",
    "back": "वापस",
    "balance": "वॉलेट बैलेंस",
    "connect": "वॉलेट कनेक्ट करें",
    "connected": "वॉलेट जुड़ा हुआ",
    "network": "नेटवर्क",
    "ethBalance": "ETH शेष",
    "tokenBalance": "MXN शेष"
  }
};
  "en": {
    "btn": "🌍 View Vision",
    "short": "To listen to the voices of the world with compassion and wisdom.",
    "medium": "MetaXuan Coin is a bridge of kindness, allowing goodwill to flow freely across borders. We believe every gentle force can change a corner of the world.",
    "long": "MetaXuan Coin is a global decentralized asset dedicated to fair resource allocation and transparent charity. Inspired by the mantra 'ॐ मणि पद्मे हूं', we use blockchain to ensure every act of kindness is seen, recorded, and amplified for lasting impact."
  },
  "zh-TW": {
    "btn": "🌍 觀看願景",
    "short": "傾聽世間的聲音，並以慈悲與智慧，回應每一份需要。",
    "medium": "玄元幣是一道連接人心的光，讓全球的善意無國界地流動。我們相信，每一份溫柔的力量，都能改變世界的角落。",
    "long": "玄元幣（MetaXuan Coin）是一項全球性去中心化資產，致力於促進公平的資源分配與慈善透明。我們以六字大明咒「ॐ मणि पद्मे हूं」的精神為靈感，結合區塊鏈技術，讓每一筆善意都被看見、被記錄、被放大，為全球弱勢族群建立可持續支持的能量網絡。"
  },
};


let currentLang = "en";
let selectedAccount = null;
let web3 = null;
const tokenAddress = "0x8CCAe437408C07A54a1b574894E2C541160Bbfed";
const tokenABI = [
  { "constant": true, "inputs": [{"name":"_owner","type":"address"}], "name": "balanceOf", "outputs": [{"name":"balance","type":"uint256"}], "type": "function" },
  { "constant": true, "inputs": [], "name": "decimals", "outputs": [{"name":"","type":"uint8"}], "type": "function" }
];

function changeLanguage() {
  const lang = document.getElementById("language").value;
  currentLang = lang;
  const t = translations[lang] || translations["en"];
  applyVisionTranslation(lang);

  document.getElementById("startBtn").innerText = t.start;
  document.getElementById("title").innerText = t.title;
  document.getElementById("label-address").innerText = t.address;
  document.getElementById("recipient").placeholder = t.enterAddress;
  document.getElementById("label-amount").innerText = t.amount;
  document.getElementById("amount").placeholder = t.enterAmount;
  document.getElementById("send").innerText = t.send;
  document.getElementById("back").innerText = `← ${t.back}`;

  updateWalletDisplay();
}

function showTransferSection() {
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("transferSection").style.display = "block";
  updateWalletDisplay();
}

function goBack() {
  document.getElementById("transferSection").style.display = "none";
  document.getElementById("startBtn").style.display = "block";
}

async function connectWallet() {
  if (window.ethereum) {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      selectedAccount = accounts[0];
      web3 = new Web3(window.ethereum);
      updateWalletDisplay();
    } catch (err) {
      alert("Wallet connection rejected.");
    }
  } else {
    alert("MetaMask not detected");
  }
}
function showVision() {
  const vision = document.getElementById("vision");
  const btn = document.getElementById("showVisionBtn");

  const isHidden = vision.style.display === "none" || vision.style.display === "";
  if (isHidden) {
    vision.style.display = "block";
    btn.innerText = visionTranslations[currentLang]?.btn || "🔙 Back";
    applyVisionTranslation(currentLang); // 套用願景文翻譯
    vision.scrollIntoView({ behavior: "smooth", block: "center" });
  } else {
    vision.style.display = "none";
    btn.innerText = visionTranslations[currentLang]?.btn || "🌍 View Vision";
  }
}

async function updateWalletDisplay() {
  if (!web3 || !selectedAccount) {
    document.getElementById("wallet-balance").innerText = translations[currentLang].connect;
    return;
  }
  const t = translations[currentLang];

  try {
    const ethBalanceWei = await web3.eth.getBalance(selectedAccount);
    const ethBalance = web3.utils.fromWei(ethBalanceWei, 'ether');

    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
    const decimals = await tokenContract.methods.decimals().call();
    const tokenBalanceRaw = await tokenContract.methods.balanceOf(selectedAccount).call();
    const tokenBalance = tokenBalanceRaw / (10 ** decimals);

    document.getElementById("wallet-balance").innerText =
      `${t.ethBalance}: ${ethBalance} ETH | ${t.tokenBalance}: ${tokenBalance} MXN`;
  } catch (e) {
    console.error("Balance error:", e);
    document.getElementById("wallet-balance").innerText = "Error loading balances";
  }
}

function sendTransaction() {
  const recipient = document.getElementById("recipient").value;
  const amount = document.getElementById("amount").value;
  const errorEl = document.getElementById("transfer-error");
  const loadingEl = document.getElementById("transfer-loading");
  const successEl = document.getElementById("transfer-success");

function applyVisionTranslation(lang) {
  const vt = visionTranslations[lang] || visionTranslations["en"];
  document.getElementById("showVisionBtn").innerText = vt.btn;
  document.querySelector(".vision-short p").innerText = vt.short;
  document.querySelector(".vision-medium p").innerText = vt.medium;
  document.querySelector(".vision-long p").innerText = vt.long;
}


  // Reset all messages
  errorEl.style.display = "none";
  loadingEl.style.display = "block";
  successEl.style.display = "none";

  if (!web3.utils.isAddress(recipient)) {
    loadingEl.style.display = "none";
    errorEl.style.display = "block";
    return;
  }

  setTimeout(() => {
    loadingEl.style.display = "none";
    successEl.style.display = "block";
    console.log(`轉帳成功 To: ${recipient}, Amount: ${amount} MXN`);
  }, 1500); // 模擬延遲
}

window.addEventListener("DOMContentLoaded", () => {
  const langRaw = navigator.language || navigator.userLanguage; // 例如 "zh-TW"、"en-US"
  const langShort = langRaw.split('-')[0]; // 例如 "zh"、"en"
  const supportedLangs = Object.keys(translations);

  // 判斷使用者語言是否被支援
  let defaultLang = "en";
  if (supportedLangs.includes(langRaw)) {
    defaultLang = langRaw;
  } else if (supportedLangs.includes(langShort)) {
    defaultLang = langShort;
  }

  // 套用語言
  document.getElementById("language").value = defaultLang;
  currentLang = defaultLang;
  changeLanguage();

  // 顯示提示
  const notice = document.createElement("div");
  notice.innerText = `🔤 語言已自動切換為：${translations[defaultLang].title || defaultLang}`;
  notice.style.position = "fixed";
  notice.style.bottom = "20px";
  notice.style.left = "50%";
  notice.style.transform = "translateX(-50%)";
  notice.style.background = "rgba(0, 0, 0, 0.7)";
  notice.style.color = "#FFD700";
  notice.style.padding = "10px 16px";
  notice.style.borderRadius = "10px";
  notice.style.fontSize = "14px";
  notice.style.zIndex = "999";
  notice.style.animation = "fadeIn 0.5s ease-in-out";

  document.body.appendChild(notice);

  // 幾秒後自動消失
  setTimeout(() => {
    notice.style.transition = "opacity 0.5s";
    notice.style.opacity = 0;
    setTimeout(() => notice.remove(), 600);
  }, 2500);

  // 點錢包餘額即可連接
  document.getElementById("wallet-balance").addEventListener("click", connectWallet);
});

function toggleVision() {
  const visionEl = document.getElementById("vision");
  if (visionEl.style.display === "none" || visionEl.style.display === "") {
    visionEl.style.display = "block";
    applyVisionTranslation(currentLang); // 切換時套用語言
  } else {
    visionEl.style.display = "none";
  }
}

function showVision() {
  const vision = document.getElementById("vision");
  const btn = document.getElementById("showVisionBtn");

  if (vision && btn) {
    // 切換顯示與隱藏
    if (vision.style.display === "none" || vision.style.display === "") {
      vision.style.display = "block";
      vision.scrollIntoView({ behavior: "smooth" });
      btn.innerText = "🔙 返回 ";
    } else {
      vision.style.display = "none";
      btn.innerText = "🌍 觀看願景 ";
    }
  }
}

